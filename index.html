<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">K-Cornhole ì‹¤ì‹œê°„ í†µí•© v4.2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --red: #d63031; --blue: #0984e3; --dark: #000000; --green: #00b894; --gold: #f1c40f; --gray: #636e72; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; margin: 0; background: #f1f2f6; color: #2d3436; line-height: 1.5; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë°˜ì‘í˜• */
        .nav-bar { background: var(--dark); padding: 10px 15px; display: flex; flex-direction: column; align-items: center; color: white; position: sticky; top:0; z-index:1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .nav-logo { font-size: 1.1rem; font-weight: 900; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .nav-logo img { height: 28px; }
        .nav-menu { display: flex; gap: 4px; width: 100%; justify-content: center; }
        .nav-link { color: #aaa; text-decoration: none; cursor: pointer; font-weight: bold; padding: 8px 10px; border-radius: 8px; font-size: 0.8rem; white-space: nowrap; flex: 1; text-align: center; }
        .nav-link.active { color: white; background: rgba(255,255,255,0.15); }

        @media (min-width: 768px) {
            .nav-bar { flex-direction: row; justify-content: space-between; padding: 12px 20px; }
            .nav-logo { margin-bottom: 0; font-size: 1.2rem; }
            .nav-menu { width: auto; gap: 8px; }
            .nav-link { padding: 10px 12px; font-size: 0.85rem; }
        }

        .container { width: 100%; max-width: 1250px; margin: 15px auto; padding: 0 10px; }
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .kca-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        @media (min-width: 768px) {
            .kca-card { border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        }

        /* ëŒ€ì§„í‘œ ë° íƒ­ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
        .category-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
        .category-tabs::-webkit-scrollbar { height: 4px; }
        .category-tabs::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
        
        .cat-tab { padding: 6px 12px; background: #e0e0e0; border-radius: 20px; cursor: pointer; font-size: 0.75rem; font-weight: bold; white-space: nowrap; }
        .cat-tab.active { background: var(--dark); color: white; }

        .bracket-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .round-column { min-width: 200px; display: flex; flex-direction: column; gap: 12px; }
        .stage-label { background: var(--dark); color: white; padding: 5px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.8rem; margin-bottom: 8px; }
        
        .match-box { border: 2px solid #eee; border-radius: 10px; padding: 10px; background: white; cursor: pointer; transition: 0.2s; }
        .player-line { display: flex; justify-content: space-between; padding: 5px; border-radius: 4px; margin: 2px 0; background: #f8f9fa; font-size: 0.8rem; align-items: center; overflow: hidden; }
        .player-line span { white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }

        /* ì‹¬íŒì„ ìŠ¤ì½”ì–´ë§ ë°˜ì‘í˜• */
        .ref-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .team-card { border-radius: 15px; padding: 12px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-top: 6px solid rgba(0,0,0,0.1); }
        .score-big { font-size: 3rem; font-weight: 1000; line-height: 1; margin: 8px 0; }
        .timer-val { font-size: 1.8rem; font-weight: 800; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 4px; font-family: monospace; }
        
        @media (min-width: 768px) {
            .score-big { font-size: 4.2rem; }
            .timer-val { font-size: 2.5rem; }
            .team-card { padding: 20px; border-top-width: 8px; }
        }

        .ctrl-btn { width: 36px; height: 36px; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 0 2px; background: white; color: var(--dark); }
        @media (min-width: 768px) {
            .ctrl-btn { width: 42px; height: 42px; font-size: 1.4rem; margin: 0 4px; }
        }

        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.85rem; width: 100%; }
        .btn-green { background: var(--green); color: white; border-bottom: 4px solid #00947a; padding: 15px; font-size: 1.1rem; }
        @media (min-width: 768px) {
            .btn-green { border-bottom-width: 5px; padding: 20px; font-size: 1.3rem; }
        }

        .rank-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .rank-table th, .rank-table td { padding: 8px 4px; border: 1px solid #eee; text-align: center; }
        @media (min-width: 768px) {
            .rank-table { font-size: 0.9rem; }
            .rank-table th, .rank-table td { padding: 12px; }
        }

        .code-input { padding: 12px; font-size: 1.5rem; border: 2px solid var(--dark); border-radius: 10px; width: 100%; max-width: 220px; text-align: center; margin-bottom: 15px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; padding: 15px; }
        .modal { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

<nav class="nav-bar">
    <a href="#" class="nav-logo"><img src="https://www.cornhole.kr/html/img/logo.png" alt="KCA"><span id="header-tournament-name"> ë°ì´í„° ì‹¤ì‹œê°„ í†µí•©</span></a>
    <div class="nav-menu">
        <div id="nav-bracket" class="nav-link active" onclick="showView('bracket')">ëŒ€ì§„í‘œ</div>
        <div id="nav-rank" class="nav-link" onclick="showView('rank')">ëŒ€íšŒ ìˆœìœ„</div>
        <div id="nav-referee" class="nav-link restricted" onclick="tryAccess('referee')">ğŸ”’ ì‹¬íŒì„</div>
        <div id="nav-hq" class="nav-link restricted" onclick="tryAccess('hq')">ğŸ”’ ìš´ì˜ë³¸ë¶€</div>
    </div>
</nav>

<div class="container">
    <section id="view-bracket" class="view-section active">
        <div class="kca-card">
            <h2 id="bracket-view-title" style="font-size: 1.2rem; margin-top:0;">ğŸ† ì „ ì¢…ëª© ëŒ€ì§„í‘œ</h2>
            <div id="cat-tabs-public" class="category-tabs"></div>
            <div id="bracket-public" class="bracket-container">
                <p style="color:#999; padding:40px; text-align:center; width:100%;">ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
            </div>
        </div>
    </section>

    <section id="view-rank" class="view-section">
        <div class="kca-card">
            <h2 id="rank-view-title" style="font-size: 1.2rem; margin-top:0;">ğŸ“Š ì¢…ëª©ë³„ ëŒ€íšŒ ìˆœìœ„</h2>
            <div id="cat-tabs-rank" class="category-tabs"></div>
            <div style="overflow-x: auto;">
                <table class="rank-table">
                    <thead><tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜ëª…</th><th>ìƒíƒœ</th><th>ë“ì‹¤ì°¨</th><th>ìŠ¹/íŒ¨</th></tr></thead>
                    <tbody id="rank-body-public"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="view-referee" class="view-section">
        <div class="kca-card">
            <h2 style="font-size: 1.1rem; margin-top:0;">âš–ï¸ ê³µì‹ ì‹¬íŒ ê¸°ë¡ì‹¤</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="ref-judge" placeholder="ì‹¬íŒëª…" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:0.8rem;">
                <input type="text" id="ref-court" placeholder="ì½”íŠ¸" style="width:60px; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:0.8rem;">
            </div>
            <div id="ref-status-bar" style="background:#f1f2f6; padding:10px; border-radius:8px; margin-bottom:10px; border-left: 5px solid var(--blue); font-size:0.8rem;">
                <span id="ref-cat-name">-</span> | <span id="ref-stage-name">-</span>
            </div>
            <div id="ref-side-zone" style="background:#fffbe6; padding:12px; border-radius:10px; border:1px solid #ffe58f; margin-bottom:10px;">
                <p style="margin:0 0 8px 0; font-size:0.85rem; font-weight:bold; text-align:center;">ğŸ² ì§„ì˜ ë°°ì •</p>
                <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                    <select id="sel-red-p" onchange="syncSides('red')" style="flex:1; padding:8px; border-radius:8px; border:2px solid var(--red); font-size:0.8rem;"></select>
                    <div style="font-weight:bold; font-size:0.8rem;">VS</div>
                    <select id="sel-blue-p" onchange="syncSides('blue')" style="flex:1; padding:8px; border-radius:8px; border:2px solid var(--blue); font-size:0.8rem;"></select>
                </div>
            </div>
            <div id="ref-engine-ui" style="display:none;">
                <div class="ref-grid">
                    <div class="team-card" style="background:var(--red);">
                        <div id="red-name-label" style="font-weight:900; font-size:0.8rem;">RED</div>
                        <div id="ref-red-total" class="score-big">0</div>
                        <div id="timer-red" class="timer-val">15</div>
                        <button class="btn" style="background:white; color:var(--red); margin:8px 0; padding:8px;" onclick="tStart('red')">START</button>
                        <div style="background:rgba(255,255,255,0.2); padding:8px; border-radius:10px; text-align:left; font-size:0.75rem;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>3ì </span><div><button class="ctrl-btn" onclick="adj('r',3,-1)">-</button><span id="r3-q">0</span><button class="ctrl-btn" onclick="adj('r',3,1)">+</button></div></div>
                            <div style="display:flex; justify-content:space-between;"><span>1ì </span><div><button class="ctrl-btn" onclick="adj('r',1,-1)">-</button><span id="r1-q">0</span><button class="ctrl-btn" onclick="adj('r',1,1)">+</button></div></div>
                            <div style="margin-top:8px; display:flex; justify-content:space-between;"><span>Out</span><b id="r0-q">4</b></div>
                        </div>
                    </div>
                    <div class="team-card" style="background:var(--blue);">
                        <div id="blue-name-label" style="font-weight:900; font-size:0.8rem;">BLUE</div>
                        <div id="ref-blue-total" class="score-big">0</div>
                        <div id="timer-blue" class="timer-val">15</div>
                        <button class="btn" style="background:white; color:var(--blue); margin:8px 0; padding:8px;" onclick="tStart('blue')">START</button>
                        <div style="background:rgba(255,255,255,0.2); padding:8px; border-radius:10px; text-align:left; font-size:0.75rem;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>3ì </span><div><button class="ctrl-btn" onclick="adj('b',3,-1)">-</button><span id="b3-q">0</span><button class="ctrl-btn" onclick="adj('b',3,1)">+</button></div></div>
                            <div style="display:flex; justify-content:space-between;"><span>1ì </span><div><button class="ctrl-btn" onclick="adj('b',1,-1)">-</button><span id="b1-q">0</span><button class="ctrl-btn" onclick="adj('b',1,1)">+</button></div></div>
                            <div style="margin-top:8px; display:flex; justify-content:space-between;"><span>Out</span><b id="b0-q">4</b></div>
                        </div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:15px; padding:15px; background:white; border-radius:12px; border:1px solid #ddd;">
                    <div id="round-info-disp" style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">RED 0 : 0 BLUE</div>
                    <button class="btn-green" onclick="submitRoundRef()">ë¼ìš´ë“œ ê²°ê³¼ í™•ì •</button>
                    <button class="btn" style="background:#95a5a6; color:white; margin-top:8px; padding:10px;" onclick="undoRoundRef()">â†©ï¸ ì§ì „ ë¼ìš´ë“œ ì·¨ì†Œ</button>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;">
                        <button class="btn btn-red" style="font-size:0.75rem; padding:8px;" onclick="declareWalkover('red')">ğŸ³ï¸ RED ê¸°ê¶Œ</button>
                        <button class="btn btn-red" style="background:var(--blue); font-size:0.75rem; padding:8px;" onclick="declareWalkover('blue')">ğŸ³ï¸ BLUE ê¸°ê¶Œ</button>
                    </div>
                    <div style="overflow-x: auto; margin-top:10px;">
                        <table class="rank-table" style="font-size: 0.7rem;"><thead><tr><th>R</th><th>RED</th><th>BLUE</th></tr></thead><tbody id="ref-hist-body"></tbody></table>
                    </div>
                    <button class="btn btn-dark" style="margin-top:15px; padding:15px;" onclick="finishMatchAuto()">ğŸ† ê²½ê¸° ì¢…ë£Œ ë° ì„œë²„ ì „ì†¡</button>
                </div>
            </div>
        </div>
    </section>

    <section id="view-hq" class="view-section">
        <div class="kca-card">
            <h2 style="font-size: 1.2rem; margin-top:0;">ğŸ¢ ëŒ€íšŒ ìš´ì˜ë³¸ë¶€</h2>
            <div style="background:#fffbe6; padding:12px; border-radius:10px; margin-bottom:15px; border: 2px solid var(--gold);">
                <b style="font-size:0.8rem; display:block; margin-bottom:5px;">ğŸ† ëŒ€íšŒëª… ê¸°ì…:</b>
                <input type="text" id="hq-tournament-name" onchange="updateTournamentName()" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; font-weight:bold;">
            </div>
            <div style="background:#f8f9fa; padding:12px; border-radius:10px; margin-bottom:15px;">
                <b style="font-size:0.8rem; display:block; margin-bottom:5px;">ğŸ“‚ ëª…ë‹¨ ë° ë°°ì •:</b>
                <input type="file" id="xlsx-hq" style="width:100%; font-size:0.75rem; margin-bottom:10px;">
                <select id="assign-mode" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px; font-size:0.8rem;">
                    <option value="rank_top">ğŸ† ë­í‚¹ (ìƒìœ„-í•˜ìœ„ ë°°ì •)</option>
                    <option value="rank_seq">ğŸ¥‡ ë­í‚¹ (ì°¨ë¡€ëŒ€ë¡œ ë°°ì •)</option>
                    <option value="random">ğŸ² ëœë¤ ë°°ì •</option>
                </select>
                <button class="btn btn-red" onclick="makeBracketsAndCloud()">ëŒ€ì§„í‘œ ìƒì„± ë° ì €ì¥</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn btn-dark" style="background:#2ecc71;" onclick="downloadTournamentData()">ğŸ“¥ ì—‘ì…€ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-red" style="font-size:0.8rem;" onclick="resetTournamentAll()">ğŸ—‘ï¸ ëŒ€íšŒ ì™„ì „ ì´ˆê¸°í™”</button>
                <button class="btn btn-dark" style="font-size:0.8rem;" onclick="changeAdminCode()">ğŸ” ë³´ì•ˆ ì½”ë“œ ë³€ê²½</button>
            </div>
            <div id="cat-tabs-admin" class="category-tabs"></div>
            <div id="bracket-admin" class="bracket-container"></div>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div style="overflow-x: auto;">
                <table class="rank-table"><thead><tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜ëª…</th><th>ìƒíƒœ</th><th>ë“ì‹¤ì°¨</th><th>ìŠ¹/íŒ¨</th></tr></thead><tbody id="rank-body-admin"></tbody></table>
            </div>
        </div>
    </section>

    <section id="view-lock" class="view-section">
        <div class="kca-card" style="text-align:center; padding:50px 20px;">
            <h2 id="lock-title" style="font-size: 1.2rem;">ë³´ì•ˆ ì¸ì¦</h2>
            <input type="password" id="code-val" class="code-input" placeholder="CODE"><br>
            <button class="btn btn-dark" style="max-width:220px;" onclick="verifyCode()">ì¸ì¦í•˜ê¸°</button>
        </div>
    </section>
</div>

<div id="detail-modal" class="overlay" onclick="closeDetail()"><div class="modal" onclick="event.stopPropagation()"><h3>ğŸ“‹ ê²½ê¸° ìƒì„¸ ê²°ê³¼</h3><div id="detail-content" style="text-align:left; font-size:0.85rem; max-height:60vh; overflow-y:auto;"></div><button class="btn btn-dark" style="margin-top:20px;" onclick="closeDetail()">ë‹«ê¸°</button></div></div>

<script>
    // --- [Firebase ì„¤ì •] ---
    const firebaseConfig = {
        apiKey: "AIzaSyDsc6BCyg6dBeym-Ll_sXctxgEA6EpTBlg",
        authDomain: "korea-cornhole.firebaseapp.com",
        projectId: "korea-cornhole",
        storageBucket: "korea-cornhole.firebasestorage.app",
        messagingSenderId: "231441387660",
        appId: "1:231441387660:web:185097a50d2e26a2802ba9",
        databaseURL: "https://korea-cornhole-default-rtdb.firebaseio.com"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    // --- [ì‹œìŠ¤í…œ ë³€ìˆ˜ ë° ì½”ë“œ ì„¤ì •] ---
    let hqAuth = localStorage.getItem('kca_hq_code') || "1234";
    let refAuth = localStorage.getItem('kca_ref_code') || "1234";
    let pendingV = "", pendingMatch = null;
    let categories = []; let currentCatIdx = 0;
    let refS = {red:0, blue:0}, refI = {r3:0, r1:0, b3:0, b1:0}, tRef = null, rLog = [], activeM = null;
    let tournamentName = "ë°ì´í„° ì‹¤ì‹œê°„ í†µí•©";

    // --- [ì„œë²„ ë¦¬ìŠ¤ë„ˆ] ---
    db.ref('kca_tournament').on('value', (snap) => {
        const data = snap.val();
        categories = data || [];
        calcStats(); 
        refreshUIs();
    });

    db.ref('kca_info/name').on('value', (snap) => {
        tournamentName = snap.val() || "ë°ì´í„° ì‹¤ì‹œê°„ í†µí•©";
        updateTitleUIs();
    });

    // --- [ë¡œì§ ìœ ì§€: ìˆ˜ì • ê¸ˆì§€ êµ¬ì—­] ---
    function updateTournamentName() {
        const newName = document.getElementById('hq-tournament-name').value;
        if(newName.trim() === "") return;
        db.ref('kca_info/name').set(newName).then(() => { alert("ëŒ€íšŒëª…ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."); });
    }

    function updateTitleUIs() {
        document.getElementById('header-tournament-name').innerText = tournamentName;
        document.getElementById('hq-tournament-name').value = tournamentName === "ë°ì´í„° ì‹¤ì‹œê°„ í†µí•©" ? "" : tournamentName;
        document.getElementById('bracket-view-title').innerText = `ğŸ† ${tournamentName} ì „ ì¢…ëª© ëŒ€ì§„í‘œ`;
        document.getElementById('rank-view-title').innerText = `ğŸ“Š ${tournamentName} ì¢…ëª©ë³„ ìˆœìœ„`;
        document.getElementById('page-title').innerText = `${tournamentName} ì‹¤ì‹œê°„ í†µí•© v4.2`;
    }

    function resetTournamentAll() {
        if (!confirm("âš ï¸ ì£¼ì˜: ëŒ€íšŒëª…, ëª…ë‹¨, ëŒ€ì§„í‘œë¥¼ í¬í•¨í•œ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
        const updates = {};
        updates['kca_tournament'] = null;
        updates['kca_info/name'] = "ë°ì´í„° ì‹¤ì‹œê°„ í†µí•©";
        db.ref().update(updates).then(() => {
            categories = []; tournamentName = "ë°ì´í„° ì‹¤ì‹œê°„ í†µí•©"; currentCatIdx = 0;
            document.getElementById('hq-tournament-name').value = "";
            renderTabs(); refreshUIs();
            alert("ì „ì²´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }).catch(err => alert("ì´ˆê¸°í™” ì˜¤ë¥˜: " + err.message));
    }

    function showView(v) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-' + v).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const tabMap = { 'bracket': 'nav-bracket', 'rank': 'nav-rank', 'referee': 'nav-referee', 'hq': 'nav-hq' };
        if(tabMap[v]) { const activeTab = document.getElementById(tabMap[v]); if(activeTab) activeTab.classList.add('active'); }
        window.scrollTo(0,0);
    }

    function tryAccess(v, mData = null) { pendingV = v; pendingMatch = mData; document.getElementById('lock-title').innerText = (v === 'hq') ? "ìš´ì˜ë³¸ë¶€ ë³´ì•ˆ ì¸ì¦" : "ì‹¬íŒì„ ë³´ì•ˆ ì¸ì¦"; showView('lock'); document.getElementById('code-val').focus(); }
    
    function verifyCode() {
        const codeInput = document.getElementById('code-val').value;
        const targetAuth = (pendingV === 'hq') ? hqAuth : refAuth;
        if(codeInput === targetAuth) {
            showView(pendingV);
            if(pendingMatch) { currentCatIdx = pendingMatch.cat; setupRefereeView(pendingMatch.r, pendingMatch.m); pendingMatch = null; }
            document.getElementById('code-val').value = "";
        } else alert("ì¸ì¦ ì‹¤íŒ¨");
    }

    function changeAdminCode() {
        let type = prompt("1: ìš´ì˜ë³¸ë¶€ ì½”ë“œ, 2: ì‹¬íŒ ì½”ë“œ", "1");
        if(type === "1") {
            let n = prompt("ìƒˆë¡œìš´ ìš´ì˜ë³¸ë¶€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", hqAuth);
            if(n) { hqAuth = n; localStorage.setItem('kca_hq_code', n); alert("ë³€ê²½ë¨"); }
        } else if(type === "2") {
            let n = prompt("ìƒˆë¡œìš´ ì‹¬íŒ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", refAuth);
            if(n) { refAuth = n; localStorage.setItem('kca_ref_code', n); alert("ë³€ê²½ë¨"); }
        }
    }

    function adj(t, p, d) {
        const cur = refI[t+'3'] + refI[t+'1'];
        if(d > 0 && cur >= 4) { alert("íŒ€ë‹¹ ìµœëŒ€ 4ê°œì…ë‹ˆë‹¤."); return; }
        refI[t+p] = Math.max(0, refI[t+p]+d);
        document.getElementById(t+p+'-q').innerText = refI[t+p];
        document.getElementById(t+'0-q').innerText = 4 - (refI[t+'3'] + refI[t+'1']);
        document.getElementById('round-info-disp').innerText = `RED ${refI.r3*3+refI.r1} : ${refI.b3*3+refI.b1} BLUE`;
    }

    function submitRoundRef() {
        let rs = refI.r3*3+refI.r1, bs = refI.b3*3+refI.b1, diff = rs-bs;
        let rg = diff>0?diff:0, bg = diff<0?Math.abs(diff):0;
        refS.red += rg; refS.blue += bg;
        rLog.push({ round: rLog.length + 1, r: rg, b: bg, r_orig: rs, b_orig: bs });
        updateRefUI();
        const row = document.getElementById('ref-hist-body').insertRow(0);
        row.innerHTML = `<td>${rLog.length}R</td><td>${rg}</td><td>${bg}</td>`;
        refI = {r3:0, r1:0, b3:0, b1:0}; 
        ["r3-q","r1-q","b3-q","b1-q"].forEach(id=>document.getElementById(id).innerText=0);
        ["r0-q","b0-q"].forEach(id=>document.getElementById(id).innerText=4);
        document.getElementById('round-info-disp').innerText = `RED 0 : 0 BLUE`;
        tStop();
        if(refS.red >= 21 || refS.blue >= 21) alert("ğŸ‰ ê²½ê¸° ì¢…ë£Œ ì ìˆ˜ ë„ë‹¬!");
    }

    function undoRoundRef() {
        if (rLog.length === 0) return alert("ì·¨ì†Œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        if (confirm("ì§ì „ ë¼ìš´ë“œ ê¸°ë¡ì„ ì·¨ì†Œí• ê¹Œìš”?")) {
            const last = rLog.pop(); refS.red -= last.r; refS.blue -= last.b;
            updateRefUI(); document.getElementById('ref-hist-body').deleteRow(0);
        }
    }

    function declareWalkover(forfeitedSide) {
        if (!activeM) return;
        const winnerSide = forfeitedSide === 'red' ? 'blue' : 'red';
        const winnerName = winnerSide === 'red' ? activeM.redP : activeM.blueP;
        if (confirm(`${forfeitedSide.toUpperCase()} ê¸°ê¶Œ, ${winnerName} ìŠ¹ë¦¬ í™•ì •?`)) {
            refS = { red: 0, blue: 0 };
            rLog = [{ round: 'W.O', r: 0, b: 0, r_orig: forfeitedSide === 'red' ? 'ê¸°ê¶Œ' : 'ìŠ¹ë¦¬', b_orig: forfeitedSide === 'blue' ? 'ê¸°ê¶Œ' : 'ìŠ¹ë¦¬' }];
            finishMatchAuto(winnerName);
        }
    }

    function finishMatchAuto(forcedWinner = null) {
        try {
            if (!activeM) throw new Error("í™œì„± ê²½ê¸° ì—†ìŒ");
            const cat = categories[currentCatIdx]; const m = cat.rounds[activeM.rIdx][activeM.mIdx];
            m.winner = forcedWinner || (refS.red > refS.blue ? activeM.redP : activeM.blueP);
            m.score = `${refS.red}:${refS.blue}`; m.redP = activeM.redP; m.blueP = activeM.blueP;
            m.history = [...rLog]; m.judge = document.getElementById('ref-judge').value || "ì‹¬íŒ";
            pushNext(activeM.rIdx, activeM.mIdx, m.winner);
            db.ref('kca_tournament').set(categories).then(() => { alert("âœ… ì „ì†¡ ì™„ë£Œ!"); showView('bracket'); }).catch(e => alert("âŒ ì˜¤ë¥˜: " + e.message));
        } catch (e) { alert("âŒ ì˜¤ë¥˜: " + e.message); }
    }

    function downloadTournamentData() {
        if (!categories || categories.length === 0) return alert("ë°ì´í„° ì—†ìŒ");
        const wb = XLSX.utils.book_new();
        categories.forEach(cat => {
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cat.players), `${cat.name}_ì°¸ê°€ì`);
            let rankData = Object.keys(cat.stats).map(n => ({ "ìˆœìœ„": 0, "ì„ ìˆ˜ëª…": n, "ìƒíƒœ": cat.stats[n].status, "ë“ì‹¤ì°¨": cat.stats[n].diff, "ìŠ¹": cat.stats[n].win, "íŒ¨": cat.stats[n].loss })).sort((a,b) => b.diff - a.diff);
            rankData.forEach((d, i) => d.ìˆœìœ„ = i + 1);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rankData), `${cat.name}_ìˆœìœ„`);
        });
        XLSX.writeFile(wb, `${tournamentName}_Data_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function updateRefUI() { document.getElementById('ref-red-total').innerText = refS.red; document.getElementById('ref-blue-total').innerText = refS.blue; }
    function tStart(t) { tStop(); let s = 15; const d = document.getElementById('timer-'+t); tRef = setInterval(() => { s--; d.innerText = s; if(s<=5) d.classList.add('warning'); if(s<=0) { clearInterval(tRef); alert("ì‹œê°„ì´ˆê³¼!"); tStop(); } }, 1000); }
    function tStop() { clearInterval(tRef); document.querySelectorAll('.timer-val').forEach(d => { d.innerText="15"; d.classList.remove('warning'); }); }
    function renderTabs() { ['cat-tabs-public', 'cat-tabs-rank', 'cat-tabs-admin'].forEach(id => { const div = document.getElementById(id); if(!div) return; div.innerHTML = ""; categories.forEach((cat, i) => { const t = document.createElement('div'); t.className = `cat-tab ${i === currentCatIdx ? 'active' : ''}`; t.innerText = cat.name; t.onclick = () => { currentCatIdx = i; renderTabs(); refreshUIs(); }; div.appendChild(t); }); }); if(categories[currentCatIdx]) { const label = document.getElementById('cat-label-admin'); if(label) label.innerText = categories[currentCatIdx].name; } }
    function calcStats() { categories.forEach(cat => { cat.stats = {}; cat.players.forEach(p => cat.stats[p.ì´ë¦„] = {diff:0, win:0, loss:0, stageRank:999, status:"ëŒ€ê¸°"}); if(cat.rounds) { cat.rounds.forEach((round, rIdx) => { round.forEach(m => { if(m.winner && m.score.includes(':')) { const s = m.score.split(':').map(Number); const winN = m.winner, lossN = (m.winner === m.redP) ? m.blueP : m.redP; const diff = Math.abs(s[0]-s[1]); const sN = Math.pow(2, cat.rounds.length - rIdx); if(cat.stats[winN]) { cat.stats[winN].diff += diff; cat.stats[winN].win++; cat.stats[winN].status = sN===2?"ìš°ìŠ¹":"ì§„í–‰ì¤‘"; } if(cat.stats[lossN]) { cat.stats[lossN].diff -= diff; cat.stats[lossN].loss++; cat.stats[lossN].status = m.stage+" íƒˆë½"; } } }); }); } }); }
    function refreshUIs() { renderBracketUI('bracket-public', false); renderBracketUI('bracket-admin', true); renderRankUI('rank-body-public'); renderRankUI('rank-body-admin'); }
    function renderBracketUI(id, isAdmin) { const root = document.getElementById(id); if(!root) return; root.innerHTML = ""; const cat = categories[currentCatIdx]; if(!cat || !cat.rounds) return; cat.rounds.forEach((round, rIdx) => { const col = document.createElement('div'); col.className = "round-column"; col.innerHTML = `<div class="stage-label">${round[0].stage}</div>`; round.forEach((m, mIdx) => { const box = document.createElement('div'); box.className = "match-box"; box.onclick = () => { if(m.winner) showDetail(rIdx, mIdx); else if(m.p1 && m.p2) tryAccess('referee', {cat:currentCatIdx, r:rIdx, m:mIdx}); }; let tag1 = m.redP === m.p1 ? '<span style="color:var(--red);font-weight:bold;">R </span>' : (m.blueP === m.p1 ? '<span style="color:var(--blue);font-weight:bold;">B </span>' : ''); let tag2 = m.redP === m.p2 ? '<span style="color:var(--red);font-weight:bold;">R </span>' : (m.blueP === m.p2 ? '<span style="color:var(--blue);font-weight:bold;">B </span>' : ''); box.innerHTML = `<div class="player-line ${m.winner===m.p1?'winner':''}"><span>${tag1}${m.p1||'.'}</span></div><div class="player-line ${m.winner===m.p2?'winner':''}"><span>${tag2}${m.p2||'.'}</span></div><div style="text-align:center; font-size:0.7rem; font-weight:bold; color:var(--gray); margin-top:5px;">${m.score || (m.p1&&m.p2?'ê¸°ì…':'ëŒ€ê¸°')}</div>`; if(isAdmin && m.winner) box.innerHTML += `<div style="color:red; font-size:0.6rem; text-align:right; margin-top:3px;" onclick="event.stopPropagation(); resetMAdmin(${rIdx},${mIdx})">ë¦¬ì…‹</div>`; col.appendChild(box); }); root.appendChild(col); }); }
    function renderRankUI(id) { const root = document.getElementById(id); if(!root) return; root.innerHTML = ""; const cat = categories[currentCatIdx]; if(!cat) return; let sorted = Object.keys(cat.stats).map(n => ({name:n, ...cat.stats[n]})); sorted.sort((a,b) => b.diff - a.diff); sorted.slice(0, 16).forEach((p, i) => { const r = root.insertRow(); r.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.status}</td><td>${p.diff}</td><td>${p.win}W ${p.loss}L</td>`; }); }
    function pushNext(r, m, w) { const cat = categories[currentCatIdx]; if(r+1 >= cat.rounds.length) return; const nextR = cat.rounds[r+1]; let nm = Math.floor(m/2); if(!nextR[nm].p1) nextR[nm].p1=w; else nextR[nm].p2=w; }
    function resetMAdmin(r, m) { if(confirm("ì´ˆê¸°í™”?")){ categories[currentCatIdx].rounds[r][m].winner=null; categories[currentCatIdx].rounds[r][m].score=""; db.ref('kca_tournament').set(categories); } }
    function showDetail(r, m) { const match = categories[currentCatIdx].rounds[r][m]; let h = `<b>ğŸ“ ë‹¨ê³„:</b> ${match.stage}<br><b>ğŸ‘¤ ì‹¬íŒ:</b> ${match.judge || '-'}<br><b>âš”ï¸ ëŒ€ì§„:</b> ${match.redP}(R) vs ${match.blueP}(B)<hr>`; (match.history||[]).forEach(i => { h += `<div>${i.round}R: RED ${i.r_orig} : ${i.b_orig} BLUE</div>`; }); h += `<hr><b style="color:var(--red)">ìµœì¢…: ${match.score}</b>`; document.getElementById('detail-content').innerHTML = h; document.getElementById('detail-modal').style.display = 'flex'; }
    function closeDetail() { document.getElementById('detail-modal').style.display = 'none'; }
    function makeBracketsAndCloud() { if(categories.length === 0) return alert("ëª…ë‹¨ ì—†ìŒ"); const mode = document.getElementById('assign-mode').value; categories.forEach(cat => { let list = [...cat.players]; if(mode === 'random') list.sort(() => Math.random() - 0.5); else list.sort((a,b) => (a.ë­í‚¹||99) - (b.ë­í‚¹||99)); const N = list.length; cat.rounds = []; let fR = []; for(let i=0; i<N/2; i++) fR.push({p1:list[i*2].ì´ë¦„, p2:list[i*2+1].ì´ë¦„, winner:null, score:"", stage:N+"ê°•", history:[], judge:"", redP:"", blueP:""}); cat.rounds.push(fR); }); db.ref('kca_tournament').set(categories).then(() => alert("ëŒ€ì§„í‘œ ìƒì„± ì™„ë£Œ")); }
    document.getElementById('xlsx-hq').addEventListener('change', function(e) { const reader = new FileReader(); reader.onload = (e) => { const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); categories = []; wb.SheetNames.forEach(name => { const list = XLSX.utils.sheet_to_json(wb.Sheets[name]); if(list.length > 0) categories.push({ name: name, players: list, rounds: [], stats: {} }); }); renderTabs(); }; reader.readAsArrayBuffer(e.target.files[0]); });
</script>
</body>
</html>